<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>فوتوشوب المبسط 4.0 — سينمائي</title>
  <!-- خطوط عربية فخمة -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;900&family=Cairo:wght@400;700;900&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: linear-gradient(135deg, #0c0c1d, #1a1a2e);
      color: #e0e0ff;
      font-family: 'Tajawal', 'Cairo', sans-serif;
      padding: 12px;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    .header {
      text-align: center;
      margin-bottom: 12px;
      color: #00f7ff;
      font-size: 28px;
      font-weight: 900;
      text-shadow: 0 0 15px rgba(0, 247, 255, 0.7);
      letter-spacing: 1px;
    }
    .main {
      display: flex;
      flex: 1;
      gap: 12px;
      overflow: hidden;
    }
    .tools {
      width: 280px;
      background: rgba(26, 26, 46, 0.85);
      backdrop-filter: blur(10px);
      padding: 16px;
      border-radius: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 0 25px rgba(106, 90, 205, 0.4);
      border: 1px solid rgba(138, 43, 226, 0.3);
    }
    .canvas-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(13, 13, 26, 0.9);
      border-radius: 16px;
      overflow: auto;
      box-shadow: inset 0 0 30px rgba(0,0,0,0.8);
      position: relative;
    }
    canvas {
      background: #0f0f1a;
      border: 2px solid #4a4a7a;
      border-radius: 12px;
      max-width: 95%;
      max-height: 85%;
      box-shadow: 0 0 30px rgba(0, 247, 255, 0.15);
    }
    button {
      padding: 11px;
      background: linear-gradient(135deg, #2d2d4f, #1e1e35);
      color: #bb86fc;
      border: 1px solid #4a4a7a;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      text-align: right;
      font-weight: 700;
      transition: all 0.25s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    button:hover {
      background: linear-gradient(135deg, #3a3a6a, #2a2a45);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      color: #ffffff;
    }
    .section {
      background: rgba(37, 37, 64, 0.7);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid #4a4a7a;
    }
    .section h3 {
      margin-bottom: 14px;
      color: #00f7ff;
      font-size: 19px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    label { display: block; margin: 10px 0; font-size: 14px; color: #d0d0ff; }
    input[type="range"], input[type="color"], select {
      width: 100%;
      margin-top: 8px;
      background: rgba(30, 30, 53, 0.8);
      border: 1px solid #4a4a7a;
      border-radius: 8px;
      padding: 6px;
      color: white;
    }
    #layers-list {
      list-style: none;
      max-height: 220px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #layers-list li {
      padding: 12px;
      background: rgba(45, 45, 70, 0.8);
      border-radius: 10px;
      cursor: grab;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #4a4a7a;
      transition: all 0.2s;
    }
    #layers-list li:hover { 
      background: rgba(53, 53, 80, 0.9);
      transform: translateX(4px);
    }
    #layers-list li.active {
      background: linear-gradient(135deg, #3700b3, #6200ee);
      color: white;
      border-color: #00f7ff;
      box-shadow: 0 0 15px rgba(0, 247, 255, 0.4);
    }
    .layer-actions {
      display: flex;
      gap: 8px;
    }
    .layer-actions button {
      padding: 5px 10px;
      font-size: 13px;
      width: auto;
      min-width: 32px;
      background: rgba(30, 30, 53, 0.8);
    }
    .file-actions {
      display: flex;
      gap: 10px;
    }
    .file-actions button {
      flex: 1;
      font-size: 14px;
    }
    .effect-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .handle {
      position: absolute;
      width: 12px;
      height: 12px;
      background: #00f7ff;
      border: 2px solid white;
      border-radius: 50%;
      cursor: nwse-resize;
      z-index: 100;
    }
  </style>
</head>
<body>
  <div class="header">✨ فوتوشوب المبسط 4.0 — سينمائي</div>

  <div class="main">
    <div class="tools">
      <!-- ملف -->
      <div class="section">
        <h3>📁 ملف</h3>
        <input type="file" id="imageLoader" accept="image/*" style="display:none" />
        <input type="file" id="projectLoader" accept=".json" style="display:none" />
        <div class="file-actions">
          <button onclick="document.getElementById('imageLoader').click()">+ صورة</button>
          <button onclick="document.getElementById('projectLoader').click()">استيراد مشروع</button>
        </div>
        <button onclick="exportProject()">تصدير مشروع</button>
        <button onclick="saveImage()" style="background: linear-gradient(135deg, #00f7ff, #00a8cc); color: #000;">💾 حفظ PNG</button>
      </div>

      <!-- أدوات -->
      <div class="section">
        <h3>🛠️ أدوات</h3>
        <button onclick="addTextLayer()">أ إضافة نص</button>
        <button onclick="addShapeLayer('rect')">▭ مستطيل</button>
        <button onclick="addShapeLayer('circle')">● دائرة</button>
        <button onclick="duplicateActiveLayer()">نسخ الطبقة</button>
        <button onclick="rotateCanvas()">🔄 تدوير الكانفاس</button>
      </div>

      <!-- الطبقات -->
      <div class="section">
        <h3>🖼️ الطبقات (اسحب لتغيير الترتيب)</h3>
        <ul id="layers-list"></ul>
        <div class="file-actions">
          <button onclick="moveLayer(-1)">▲ رفع</button>
          <button onclick="moveLayer(1)">▼ خفض</button>
          <button onclick="deleteActiveLayer()" style="background: linear-gradient(135deg, #ff416c, #ff4b2b);">❌ حذف</button>
        </div>
      </div>

      <!-- إعدادات الكائن -->
      <div class="section" id="object-settings" style="display:none">
        <h3>⚙️ إعدادات الكائن</h3>
        <div id="text-controls" style="display:none">
          <label>النص: <input type="text" id="textInput" value="نص جديد"></label>
          <label>الخط: 
            <select id="fontSelect">
              <option value="'Tajawal'">Tajawal (فاخر)</option>
              <option value="'Cairo'">Cairo (عريض)</option>
              <option value="'Amiri'">Amiri (كلاسيكي)</option>
              <option value="Arial">Arial</option>
            </select>
          </label>
          <label>الحجم: <input type="range" id="fontSize" min="12" max="200" value="60"></label>
        </div>
        <label>اللون: <input type="color" id="objectColor" value="#ffffff"></label>
        <label>الشفافية: <input type="range" id="objectOpacity" min="0" max="1" step="0.01" value="1"></label>
        <label>التدوير (°): <input type="range" id="objectRotation" min="0" max="360" value="0"></label>
        <label>التحجيم: <input type="range" id="objectScale" min="10" max="300" value="100" oninput="updateScalePreview()"></label>
        <div class="effect-grid">
          <label><input type="checkbox" id="shadow"> ظل</label>
          <label><input type="checkbox" id="glow"> توهج</label>
          <label><input type="checkbox" id="reflection"> انعكاس</label>
          <label><input type="checkbox" id="gradient"> تدرج</label>
        </div>
      </div>

      <!-- فلاتر احترافية -->
      <div class="section">
        <h3>🎨 فلاتر احترافية</h3>
        <label>سطوع: <input type="range" id="brightness" min="-100" max="100" value="0"></label>
        <label>تباين: <input type="range" id="contrast" min="-100" max="100" value="0"></label>
        <label>ضبابية: <input type="range" id="blur" min="0" max="10" step="0.1" value="0"></label>
        <label>حدّة: <input type="range" id="sharpen" min="0" max="5" step="0.1" value="0"></label>
        <button onclick="applyFiltersToLayer()">تطبيق على الطبقة</button>
      </div>
    </div>

    <div class="canvas-container" id="canvasContainer">
      <canvas id="mainCanvas" width="800" height="600"></canvas>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const container = document.getElementById('canvasContainer');
    let layers = [];
    let activeLayerId = null;
    let isDragging = false;
    let isResizing = false;
    let resizeHandle = null;
    let dragStart = { x: 0, y: 0, mouseX: 0, mouseY: 0 };
    let resizeStart = { width: 0, height: 0, mouseX: 0, mouseY: 0 };

    // تهيئة الكانفاس
    function initCanvas() {
      ctx.fillStyle = '#0f0f1a';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#00f7ff';
      ctx.font = '28px "Tajawal"';
      ctx.textAlign = 'center';
      ctx.fillText('✨ ابدأ بتحميل صورة أو إضافة نص', canvas.width / 2, canvas.height / 2);
    }
    initCanvas();

    // تحميل صورة
    document.getElementById('imageLoader').addEventListener('change', (e) => {
      if (!e.target.files[0]) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          const id = Date.now();
          layers.push({
            id,
            type: 'image',
            visible: true,
            x: canvas.width / 2,
            y: canvas.height / 2,
            width: img.width > canvas.width ? canvas.width : img.width,
            height: img.height > canvas.height ? (img.height * (canvas.width / img.width)) : img.height,
            rotation: 0,
            scale: 100,
            opacity: 1,
            img,
            effects: { shadow: false, glow: false, reflection: false, gradient: false },
            filters: { brightness: 0, contrast: 0, blur: 0, sharpen: 0 }
          });
          setActiveLayer(id);
          renderCanvas();
          updateLayersList();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    });

    // إضافة نص
    function addTextLayer() {
      const id = Date.now();
      layers.push({
        id,
        type: 'text',
        visible: true,
        x: canvas.width / 2,
        y: canvas.height / 2,
        width: 300,
        height: 80,
        rotation: 0,
        scale: 100,
        opacity: 1,
         {
          text: 'نص جديد',
          font: "'Tajawal'",
          size: 60,
          color: '#ffffff'
        },
        effects: { shadow: true, glow: false, reflection: false, gradient: false },
        filters: { brightness: 0, contrast: 0, blur: 0, sharpen: 0 }
      });
      setActiveLayer(id);
      renderCanvas();
      updateLayersList();
    }

    // إضافة شكل
    function addShapeLayer(type) {
      const id = Date.now();
      layers.push({
        id,
        type,
        visible: true,
        x: canvas.width / 2,
        y: canvas.height / 2,
        width: type === 'rect' ? 200 : 150,
        height: type === 'rect' ? 100 : 150,
        rotation: 0,
        scale: 100,
        opacity: 1,
         {
          color: type === 'rect' ? '#ff5252' : '#ffeb3b'
        },
        effects: { shadow: true, glow: false, reflection: false, gradient: false },
        filters: { brightness: 0, contrast: 0, blur: 0, sharpen: 0 }
      });
      setActiveLayer(id);
      renderCanvas();
      updateLayersList();
    }

    // تعيين الطبقة النشطة
    function setActiveLayer(id) {
      activeLayerId = id;
      const layer = layers.find(l => l.id === id);
      const settings = document.getElementById('object-settings');
      if (layer && (layer.type === 'text' || layer.type === 'rect' || layer.type === 'circle' || layer.type === 'image')) {
        settings.style.display = 'block';
        if (layer.type === 'text') {
          document.getElementById('text-controls').style.display = 'block';
          const d = layer.data;
          document.getElementById('textInput').value = d.text;
          document.getElementById('fontSelect').value = d.font;
          document.getElementById('fontSize').value = d.size;
        } else {
          document.getElementById('text-controls').style.display = 'none';
        }
        document.getElementById('objectColor').value = layer.type === 'text' ? layer.data.color : layer.data.color;
        document.getElementById('objectOpacity').value = layer.opacity;
        document.getElementById('objectRotation').value = layer.rotation;
        document.getElementById('objectScale').value = layer.scale;
        document.getElementById('shadow').checked = layer.effects.shadow;
        document.getElementById('glow').checked = layer.effects.glow;
        document.getElementById('reflection').checked = layer.effects.reflection;
        document.getElementById('gradient').checked = layer.effects.gradient;
      } else {
        settings.style.display = 'none';
      }
      updateLayersList();
    }

    // ربط الإعدادات
    document.getElementById('textInput').addEventListener('input', updateActiveObject);
    document.getElementById('fontSelect').addEventListener('change', updateActiveObject);
    document.getElementById('fontSize').addEventListener('input', updateActiveObject);
    document.getElementById('objectColor').addEventListener('input', updateActiveObject);
    document.getElementById('objectOpacity').addEventListener('input', updateActiveObject);
    document.getElementById('objectRotation').addEventListener('input', updateActiveObject);
    document.getElementById('objectScale').addEventListener('input', updateActiveObject);
    document.getElementById('shadow').addEventListener('change', updateActiveObject);
    document.getElementById('glow').addEventListener('change', updateActiveObject);
    document.getElementById('reflection').addEventListener('change', updateActiveObject);
    document.getElementById('gradient').addEventListener('change', updateActiveObject);

    function updateActiveObject() {
      const layer = layers.find(l => l.id === activeLayerId);
      if (!layer) return;
      if (layer.type === 'text') {
        layer.data.text = document.getElementById('textInput').value;
        layer.data.font = document.getElementById('fontSelect').value;
        layer.data.size = parseInt(document.getElementById('fontSize').value);
        layer.data.color = document.getElementById('objectColor').value;
      } else if (layer.type === 'image') {
        // لا نغير لون الصورة
      } else {
        layer.data.color = document.getElementById('objectColor').value;
      }
      layer.opacity = parseFloat(document.getElementById('objectOpacity').value);
      layer.rotation = parseInt(document.getElementById('objectRotation').value);
      layer.scale = parseInt(document.getElementById('objectScale').value);
      layer.effects.shadow = document.getElementById('shadow').checked;
      layer.effects.glow = document.getElementById('glow').checked;
      layer.effects.reflection = document.getElementById('reflection').checked;
      layer.effects.gradient = document.getElementById('gradient').checked;
      renderCanvas();
    }

    function updateScalePreview() {
      // يمكن إضافة معاينة لاحقًا
    }

    // تطبيق الفلاتر على الطبقة المختارة
    function applyFiltersToLayer() {
      const layer = layers.find(l => l.id === activeLayerId);
      if (!layer) return;
      layer.filters = {
        brightness: parseInt(document.getElementById('brightness').value),
        contrast: parseInt(document.getElementById('contrast').value),
        blur: parseFloat(document.getElementById('blur').value),
        sharpen: parseFloat(document.getElementById('sharpen').value)
      };
      renderCanvas();
    }

    // رسم طبقة مع تأثيرات وفلاتر
    function drawLayer(layer) {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      const tempCtx = tempCanvas.getContext('2d');

      const scale = layer.scale / 100;
      const w = layer.width * scale;
      const h = layer.height * scale;
      const centerX = layer.x;
      const centerY = layer.y;

      tempCtx.save();
      tempCtx.translate(centerX, centerY);
      tempCtx.rotate((layer.rotation * Math.PI) / 180);

      // رسم المحتوى
      if (layer.type === 'image') {
        tempCtx.globalAlpha = layer.opacity;
        tempCtx.drawImage(layer.img, -w/2, -h/2, w, h);
      } else if (layer.type === 'text') {
        const d = layer.data;
        tempCtx.globalAlpha = layer.opacity;
        tempCtx.font = `${d.size * scale}px ${d.font}`;
        tempCtx.textAlign = 'center';
        tempCtx.textBaseline = 'middle';
        
        // تدرج لوني للنص
        if (layer.effects.gradient) {
          const gradient = tempCtx.createLinearGradient(-w/2, -h/2, w/2, h/2);
          gradient.addColorStop(0, d.color);
          gradient.addColorStop(1, '#00f7ff');
          tempCtx.fillStyle = gradient;
        } else {
          tempCtx.fillStyle = d.color;
        }

        // تأثيرات
        if (layer.effects.shadow) {
          tempCtx.shadowColor = 'rgba(0,0,0,0.7)';
          tempCtx.shadowBlur = 10;
          tempCtx.shadowOffsetX = 4;
          tempCtx.shadowOffsetY = 4;
        }
        if (layer.effects.glow) {
          tempCtx.shadowColor = d.color;
          tempCtx.shadowBlur = 20;
        }
        tempCtx.fillText(d.text, 0, 0);
        tempCtx.shadowBlur = 0;
        tempCtx.shadowColor = 'transparent';

        // انعكاس
        if (layer.effects.reflection) {
          tempCtx.save();
          tempCtx.globalAlpha = layer.opacity * 0.3;
          tempCtx.scale(1, -1);
          tempCtx.fillText(d.text, 0, -h);
          tempCtx.restore();
        }
      } else if (layer.type === 'rect' || layer.type === 'circle') {
        const d = layer.data;
        tempCtx.globalAlpha = layer.opacity;
        
        if (layer.effects.gradient) {
          const gradient = tempCtx.createRadialGradient(0, 0, 0, 0, 0, Math.max(w, h)/2);
          gradient.addColorStop(0, d.color);
          gradient.addColorStop(1, '#00f7ff');
          tempCtx.fillStyle = gradient;
          tempCtx.strokeStyle = 'transparent';
        } else {
          tempCtx.fillStyle = d.color;
          tempCtx.strokeStyle = d.color;
        }
        tempCtx.lineWidth = 3;

        if (layer.effects.shadow) {
          tempCtx.shadowColor = 'rgba(0,0,0,0.7)';
          tempCtx.shadowBlur = 10;
          tempCtx.shadowOffsetX = 4;
          tempCtx.shadowOffsetY = 4;
        }
        if (layer.effects.glow) {
          tempCtx.shadowColor = d.color;
          tempCtx.shadowBlur = 20;
        }

        if (layer.type === 'rect') {
          tempCtx.fillRect(-w/2, -h/2, w, h);
          tempCtx.strokeRect(-w/2, -h/2, w, h);
        } else {
          tempCtx.beginPath();
          tempCtx.arc(0, 0, w/2, 0, Math.PI * 2);
          tempCtx.fill();
          tempCtx.stroke();
        }
        tempCtx.shadowBlur = 0;
        tempCtx.shadowColor = 'transparent';

        // انعكاس
        if (layer.effects.reflection) {
          tempCtx.save();
          tempCtx.globalAlpha = layer.opacity * 0.3;
          tempCtx.scale(1, -1);
          if (layer.type === 'rect') {
            tempCtx.fillRect(-w/2, -h/2 - h, w, h);
          } else {
            tempCtx.beginPath();
            tempCtx.arc(0, -h, w/2, 0, Math.PI * 2);
            tempCtx.fill();
          }
          tempCtx.restore();
        }
      }
      tempCtx.restore();

      // تطبيق الفلاتر
      const f = layer.filters || {};
      let filter = '';
      if (f.brightness !== 0) filter += `brightness(${100 + f.brightness}%) `;
      if (f.contrast !== 0) filter += `contrast(${100 + f.contrast}%) `;
      if (f.blur > 0) filter += `blur(${f.blur}px) `;
      // Sharpen غير مدعوم في CSS filter، لذا نتجاهله هنا (يمكن إضافته لاحقًا بمعالجة بكسلية)

      if (filter.trim()) {
        ctx.filter = filter;
        ctx.drawImage(tempCanvas, 0, 0);
        ctx.filter = 'none';
      } else {
        ctx.drawImage(tempCanvas, 0, 0);
      }
    }

    // رسم كل الطبقات
    function renderCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      layers.forEach(layer => {
        if (layer.visible) {
          drawLayer(layer);
        }
      });
      // رسم مقابض التحجيم إذا كانت الطبقة نشطة
      drawResizeHandles();
    }

    // رسم مقابض التحجيم
    function drawResizeHandles() {
      if (activeLayerId === null) return;
      const layer = layers.find(l => l.id === activeLayerId);
      if (!layer || layer.type === 'image') return; // ندعم التحجيم للنصوص والأشكال فقط

      const scale = layer.scale / 100;
      const w = layer.width * scale;
      const h = layer.height * scale;
      const x = layer.x - w/2;
      const y = layer.y - h/2;

      // إزالة المقابض القديمة
      const handles = document.querySelectorAll('.handle');
      handles.forEach(h => h.remove());

      // إضافة مقبض جديد
      const handle = document.createElement('div');
      handle.className = 'handle';
      handle.style.left = (x + w - 6) + 'px';
      handle.style.top = (y + h - 6) + 'px';
      handle.dataset.layerId = layer.id;
      container.appendChild(handle);

      handle.addEventListener('mousedown', (e) => {
        e.stopPropagation();
        isResizing = true;
        resizeHandle = layer;
        resizeStart = {
          width: w,
          height: h,
          mouseX: e.clientX,
          mouseY: e.clientY
        };
        canvas.style.cursor = 'nwse-resize';
      });
    }

    // أحداث الماوس
    canvas.addEventListener('mousedown', (e) => {
      if (isResizing) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      for (let i = layers.length - 1; i >= 0; i--) {
        const layer = layers[i];
        if (!layer.visible) continue;
        const scale = layer.scale / 100;
        const w = layer.width * scale;
        const h = layer.height * scale;
        const left = layer.x - w/2;
        const top = layer.y - h/2;
        const right = left + w;
        const bottom = top + h;

        if (x >= left && x <= right && y >= top && y <= bottom) {
          isDragging = true;
          dragStart = { 
            x: layer.x, 
            y: layer.y, 
            mouseX: x, 
            mouseY: y 
          };
          setActiveLayer(layer.id);
          canvas.style.cursor = 'grabbing';
          return;
        }
      }
    });

    canvas.addEventListener('mousemove', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      if (isResizing && resizeHandle) {
        const dx = x - (resizeHandle.x - (resizeHandle.width * (resizeHandle.scale/100))/2 + (resizeHandle.width * (resizeHandle.scale/100)));
        const newWidth = Math.max(20, resizeStart.width + dx);
        const aspectRatio = resizeHandle.width / resizeHandle.height;
        const newHeight = newWidth / aspectRatio;
        resizeHandle.width = newWidth;
        resizeHandle.height = newHeight;
        renderCanvas();
        return;
      }

      if (isDragging) {
        const layer = layers.find(l => l.id === activeLayerId);
        if (layer) {
          layer.x = dragStart.x + (x - dragStart.mouseX);
          layer.y = dragStart.y + (y - dragStart.mouseY);
          renderCanvas();
        }
      }
    });

    canvas.addEventListener('mouseup', () => {
      isDragging = false;
      isResizing = false;
      resizeHandle = null;
      canvas.style.cursor = 'default';
      renderCanvas();
    });

    canvas.addEventListener('mouseleave', () => {
      isDragging = false;
      isResizing = false;
      resizeHandle = null;
      canvas.style.cursor = 'default';
    });

    // باقي الوظائف (moveLayer, duplicate, delete, rotate, export, save...)
    function moveLayer(direction) {
      if (activeLayerId === null) return;
      const index = layers.findIndex(l => l.id === activeLayerId);
      if (index === -1) return;
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= layers.length) return;
      [layers[index], layers[newIndex]] = [layers[newIndex], layers[index]];
      updateLayersList();
      renderCanvas();
    }

    function duplicateActiveLayer() {
      if (activeLayerId === null) return;
      const layer = layers.find(l => l.id === activeLayerId);
      if (!layer) return;
      const newLayer = JSON.parse(JSON.stringify(layer));
      newLayer.id = Date.now();
      layers.push(newLayer);
      activeLayerId = newLayer.id;
      renderCanvas();
      updateLayersList();
    }

    function deleteActiveLayer() {
      if (activeLayerId === null) return;
      if (!confirm('هل أنت متأكد من حذف هذه الطبقة؟')) return;
      layers = layers.filter(l => l.id !== activeLayerId);
      activeLayerId = layers.length > 0 ? layers[layers.length - 1].id : null;
      document.getElementById('object-settings').style.display = 'none';
      renderCanvas();
      updateLayersList();
    }

    function rotateCanvas() {
      if (layers.length === 0) return;
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = canvas.height;
      tempCanvas.height = canvas.width;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.translate(tempCanvas.width / 2, tempCanvas.height / 2);
      tempCtx.rotate(Math.PI / 2);
      tempCtx.drawImage(canvas, -canvas.width / 2, -canvas.height / 2);

      const newImg = new Image();
      newImg.src = tempCanvas.toDataURL();
      newImg.onload = () => {
        layers = [{
          id: Date.now(),
          type: 'image',
          visible: true,
          x: tempCanvas.width / 2,
          y: tempCanvas.height / 2,
          width: tempCanvas.width,
          height: tempCanvas.height,
          rotation: 0,
          scale: 100,
          opacity: 1,
          img: newImg,
          effects: { shadow: false, glow: false, reflection: false, gradient: false },
          filters: { brightness: 0, contrast: 0, blur: 0, sharpen: 0 }
        }];
        canvas.width = tempCanvas.width;
        canvas.height = tempCanvas.height;
        activeLayerId = layers[0].id;
        renderCanvas();
        updateLayersList();
      };
    }

    function saveImage() {
      const link = document.createElement('a');
      link.download = 'photo-edit.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    function exportProject() {
      const project = { layers: layers.map(l => {
        const layer = {...l};
        if (l.type === 'image' && l.img) {
          layer.imgData = l.img.src;
        }
        delete layer.img;
        return layer;
      }) };
      const dataStr = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(project, null, 2));
      const dlAnchorElem = document.createElement('a');
      dlAnchorElem.setAttribute("href", dataStr);
      dlAnchorElem.setAttribute("download", "project.json");
      dlAnchorElem.click();
    }

    document.getElementById('projectLoader').addEventListener('change', (e) => {
      if (!e.target.files[0]) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const project = JSON.parse(event.target.result);
          layers = [];
          let imagesLoaded = 0;
          const totalImages = project.layers.filter(l => l.type === 'image').length;
          project.layers.forEach(l => {
            const layer = {...l};
            if (layer.type === 'image' && layer.imgData) {
              const img = new Image();
              img.src = layer.imgData;
              img.onload = () => {
                layer.img = img;
                imagesLoaded++;
                if (imagesLoaded === totalImages || totalImages === 0) {
                  activeLayerId = layers.length > 0 ? layers[0].id : null;
                  renderCanvas();
                  updateLayersList();
                }
              };
            }
            layers.push(layer);
          });
          if (totalImages === 0) {
            activeLayerId = layers.length > 0 ? layers[0].id : null;
            renderCanvas();
            updateLayersList();
          }
        } catch (err) {
          alert('خطأ في تحميل المشروع: ' + err.message);
        }
      };
      reader.readAsText(e.target.files[0]);
    });

    function updateLayersList() {
      const list = document.getElementById('layers-list');
      list.innerHTML = '';
      layers.slice().reverse().forEach(layer => {
        const li = document.createElement('li');
        li.dataset.id = layer.id;
        li.innerHTML = `${layer.type === 'image' ? '🖼️' : layer.type === 'text' ? 'أ' : '▭'} الطبقة ${layer.id}`;
        li.className = layer.id === activeLayerId ? 'active' : '';
        li.draggable = true;
        li.onclick = () => setActiveLayer(layer.id);
        
        const actions = document.createElement('div');
        actions.className = 'layer-actions';
        const toggleBtn = document.createElement('button');
        toggleBtn.textContent = layer.visible ? '👁️' : '🙈';
        toggleBtn.onclick = (e) => {
          e.stopPropagation();
          layer.visible = !layer.visible;
          renderCanvas();
          updateLayersList();
        };
        actions.appendChild(toggleBtn);
        li.appendChild(actions);
        list.appendChild(li);
      });

      // Drag & Drop للطبقات
      const items = list.querySelectorAll('li');
      items.forEach(item => {
        item.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', item.dataset.id);
          setTimeout(() => item.style.opacity = '0.5', 0);
        });
        item.addEventListener('dragover', (e) => {
          e.preventDefault();
        });
        item.addEventListener('drop', (e) => {
          e.preventDefault();
          const srcId = e.dataTransfer.getData('text/plain');
          const targetId = item.dataset.id;
          const srcIndex = layers.findIndex(l => l.id == srcId);
          const targetIndex = layers.findIndex(l => l.id == targetId);
          if (srcIndex !== -1 && targetIndex !== -1 && srcIndex !== targetIndex) {
            const [moved] = layers.splice(srcIndex, 1);
            layers.splice(targetIndex, 0, moved);
            renderCanvas();
            updateLayersList();
          }
        });
        item.addEventListener('dragend', () => {
          item.style.opacity = '1';
        });
      });
    }

    // بدء التشغيل
    updateLayersList();
  </script>
</body>
</html>
